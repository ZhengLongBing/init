# 概要设计编写指南 (HLD)

---

## 核心理念

### HLD 的定位

| 文档 | 回答什么 | 粒度 |
|------|----------|------|
| 架构设计 | 为什么这样设计？ | 战略 |
| **概要设计 (HLD)** | **系统由哪些部分组成？如何交互？** | **战术** |
| 详细设计 | 具体怎么实现？ | 执行 |

### HLD 的三个核心问题

1. **子系统划分**：系统拆成哪几块？各自负责什么？
2. **接口契约**：模块之间如何通信？数据格式是什么？
3. **数据模型**：核心实体有哪些？关系是什么？

### 小团队原则

- **接口先行**：先定契约，再写实现
- **最小拆分**：能不拆就不拆，拆了就要有明确边界
- **契约即文档**：OpenAPI/类型定义就是最好的文档

---

## 文档结构

```
hld.md
├── 1. 子系统划分     → 系统由哪些部分组成
├── 2. 接口定义       → 模块间如何通信
├── 3. 数据模型       → 核心实体和关系
├── 4. 关键流程       → 典型场景的时序
└── 5. 非功能设计     → 安全/性能/可观测
```

---

## 完整模板

### 1. 子系统划分

#### 1.1 子系统总览

```
┌─────────────────────────────────────────────────────┐
│                    API 网关层                        │
│              (路由/认证/限流/日志)                    │
└───────────┬─────────────┬─────────────┬─────────────┘
            │             │             │
    ┌───────▼───────┐ ┌───▼───┐ ┌───────▼───────┐
    │   用户子系统   │ │ 订单  │ │   通知子系统   │
    │              │ │ 子系统 │ │              │
    │ • 注册登录    │ │       │ │ • 邮件通知    │
    │ • 权限管理    │ │ • 下单 │ │ • 站内信     │
    │ • 个人信息    │ │ • 支付 │ │ • 推送       │
    └───────┬───────┘ └───┬───┘ └───────┬───────┘
            │             │             │
    ┌───────▼─────────────▼─────────────▼───────┐
    │                 基础设施层                  │
    │     (数据库/缓存/消息队列/对象存储)          │
    └───────────────────────────────────────────┘
```

#### 1.2 子系统职责矩阵

| 子系统 | 职责 | 数据归属 | 对外接口 | 依赖 |
|--------|------|----------|----------|------|
| 用户 | 身份认证、权限管理 | users, roles | REST API | - |
| 订单 | 订单生命周期管理 | orders, items | REST API | 用户 |
| 通知 | 多渠道消息推送 | notifications | 异步队列 | 用户 |

#### 1.3 子系统边界规则

```
✅ 允许
• 通过 API 调用其他子系统
• 通过事件订阅其他子系统的变更
• 缓存其他子系统的只读数据

❌ 禁止
• 直接访问其他子系统的数据库
• 在代码中 use 其他子系统的内部模块
• 绕过 API 直接调用内部函数
```

---

### 2. 接口定义

#### 2.1 接口设计原则

| 原则 | 说明 | 示例 |
|------|------|------|
| RESTful | 资源 + 动词 | `GET /users/{id}` |
| 版本化 | URL 或 Header | `/api/v1/users` |
| 幂等性 | 重复调用安全 | PUT/DELETE 幂等 |
| 统一错误 | 标准错误格式 | `{ "error": { "code": "", "message": "" } }` |

#### 2.2 API 契约模板

```yaml
# openapi.yaml 片段
paths:
  /api/v1/users:
    post:
      summary: 创建用户
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'

components:
  schemas:
    CreateUserRequest:
      type: object
      required: [username, email, password]
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 32
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8

    UserResponse:
      type: object
      properties:
        id:
          type: integer
        username:
          type: string
        email:
          type: string
        created_at:
          type: string
          format: date-time
```

#### 2.3 Rust 类型定义

```rust
// dto/user.rs - 与 OpenAPI 对应的类型定义

/// 创建用户请求
#[derive(Debug, Deserialize, Validate)]
pub struct CreateUserRequest {
    #[validate(length(min = 3, max = 32))]
    pub username: String,
    #[validate(email)]
    pub email: String,
    #[validate(length(min = 8, max = 128))]
    pub password: String,
}

/// 用户响应
#[derive(Debug, Serialize)]
pub struct UserResponse {
    pub id: i64,
    pub username: String,
    pub email: String,
    pub created_at: DateTime<Utc>,
}

/// 分页请求（通用）
#[derive(Debug, Deserialize)]
pub struct PaginationQuery {
    #[serde(default = "default_page")]
    pub page: u32,
    #[serde(default = "default_limit")]
    pub limit: u32,
}

fn default_page() -> u32 { 1 }
fn default_limit() -> u32 { 20 }

/// 分页响应（通用）
#[derive(Debug, Serialize)]
pub struct PaginatedResponse<T> {
    pub data: Vec<T>,
    pub total: i64,
    pub page: u32,
    pub limit: u32,
}
```

#### 2.4 内部接口（子系统间）

```rust
// 用户子系统对外暴露的 trait
#[async_trait]
pub trait UserService: Send + Sync {
    /// 根据 ID 获取用户（供其他子系统调用）
    async fn get_by_id(&self, id: i64) -> Result<Option<User>, AppError>;
    
    /// 批量获取用户（优化 N+1 查询）
    async fn get_by_ids(&self, ids: &[i64]) -> Result<Vec<User>, AppError>;
    
    /// 验证用户权限
    async fn has_permission(&self, user_id: i64, permission: &str) -> Result<bool, AppError>;
}
```

#### 2.5 统一错误格式

```rust
/// API 错误响应
#[derive(Debug, Serialize)]
pub struct ApiError {
    pub error: ErrorBody,
}

#[derive(Debug, Serialize)]
pub struct ErrorBody {
    pub code: String,      // 机器可读：USER_NOT_FOUND
    pub message: String,   // 人类可读：用户不存在
    #[serde(skip_serializing_if = "Option::is_none")]
    pub details: Option<Vec<FieldError>>,  // 字段级错误
}

#[derive(Debug, Serialize)]
pub struct FieldError {
    pub field: String,
    pub message: String,
}

// 错误码枚举
pub enum ErrorCode {
    // 通用
    ValidationFailed,
    Unauthorized,
    Forbidden,
    NotFound,
    Conflict,
    Internal,
    
    // 业务相关
    UserNotFound,
    UserAlreadyExists,
    InvalidCredentials,
    OrderNotFound,
}
```

---

### 3. 数据模型

#### 3.1 实体关系图 (ERD)

```
┌──────────────┐       ┌──────────────┐
│    users     │       │    roles     │
├──────────────┤       ├──────────────┤
│ id           │──┐    │ id           │
│ username     │  │    │ name         │
│ email        │  │    │ permissions  │
│ password_hash│  │    └──────────────┘
│ role_id      │──┼──────────┘
│ created_at   │  │
│ updated_at   │  │
└──────────────┘  │
                  │    ┌──────────────┐
                  │    │   orders     │
                  │    ├──────────────┤
                  └───▶│ id           │
                       │ user_id      │
                       │ status       │
                       │ total_amount │
                       │ created_at   │
                       └──────┬───────┘
                              │
                              │ 1:N
                              ▼
                       ┌──────────────┐
                       │ order_items  │
                       ├──────────────┤
                       │ id           │
                       │ order_id     │
                       │ product_id   │
                       │ quantity     │
                       │ price        │
                       └──────────────┘
```

#### 3.2 核心实体定义

```rust
// domain/user.rs

/// 用户实体
#[derive(Debug, Clone, FromRow)]
pub struct User {
    pub id: i64,
    pub username: String,
    pub email: String,
    pub password_hash: String,
    pub role_id: i64,
    pub status: UserStatus,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Copy, sqlx::Type)]
#[sqlx(type_name = "user_status", rename_all = "snake_case")]
pub enum UserStatus {
    Active,
    Inactive,
    Banned,
}

// domain/order.rs

/// 订单实体
#[derive(Debug, Clone, FromRow)]
pub struct Order {
    pub id: i64,
    pub user_id: i64,
    pub status: OrderStatus,
    pub total_amount: Decimal,
    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}

#[derive(Debug, Clone, Copy, sqlx::Type)]
#[sqlx(type_name = "order_status", rename_all = "snake_case")]
pub enum OrderStatus {
    Pending,     // 待支付
    Paid,        // 已支付
    Shipped,     // 已发货
    Completed,   // 已完成
    Cancelled,   // 已取消
}
```

#### 3.3 数据库 Schema

```sql
-- migrations/001_init.sql

-- 用户表
CREATE TABLE users (
    id            BIGSERIAL PRIMARY KEY,
    username      VARCHAR(32) NOT NULL UNIQUE,
    email         VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    role_id       BIGINT NOT NULL REFERENCES roles(id),
    status        user_status NOT NULL DEFAULT 'active',
    created_at    TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at    TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);

-- 订单表
CREATE TABLE orders (
    id           BIGSERIAL PRIMARY KEY,
    user_id      BIGINT NOT NULL REFERENCES users(id),
    status       order_status NOT NULL DEFAULT 'pending',
    total_amount DECIMAL(10, 2) NOT NULL,
    created_at   TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at   TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_orders_user_id ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
```

---

### 4. 关键流程

#### 4.1 用户注册流程

```
客户端                API网关              用户服务              数据库
  │                    │                    │                    │
  │  POST /register    │                    │                    │
  │───────────────────▶│                    │                    │
  │                    │  验证 Token        │                    │
  │                    │  (无需认证)         │                    │
  │                    │                    │                    │
  │                    │  转发请求          │                    │
  │                    │───────────────────▶│                    │
  │                    │                    │                    │
  │                    │                    │  检查用户名        │
  │                    │                    │───────────────────▶│
  │                    │                    │◀───────────────────│
  │                    │                    │                    │
  │                    │                    │  密码哈希          │
  │                    │                    │  (Argon2id)        │
  │                    │                    │                    │
  │                    │                    │  INSERT user       │
  │                    │                    │───────────────────▶│
  │                    │                    │◀───────────────────│
  │                    │                    │                    │
  │                    │  201 + User        │                    │
  │                    │◀───────────────────│                    │
  │  201 Created       │                    │                    │
  │◀───────────────────│                    │                    │
```

#### 4.2 下单流程

```
客户端              API网关            订单服务           用户服务           数据库
  │                  │                  │                  │                  │
  │ POST /orders     │                  │                  │                  │
  │─────────────────▶│                  │                  │                  │
  │                  │ 验证 JWT         │                  │                  │
  │                  │─────────────────▶│                  │                  │
  │                  │                  │                  │                  │
  │                  │                  │ 获取用户信息      │                  │
  │                  │                  │─────────────────▶│                  │
  │                  │                  │◀─────────────────│                  │
  │                  │                  │                  │                  │
  │                  │                  │ 开启事务                            │
  │                  │                  │─────────────────────────────────────▶│
  │                  │                  │                                     │
  │                  │                  │ INSERT order                        │
  │                  │                  │─────────────────────────────────────▶│
  │                  │                  │                                     │
  │                  │                  │ INSERT order_items                  │
  │                  │                  │─────────────────────────────────────▶│
  │                  │                  │                                     │
  │                  │                  │ 提交事务                            │
  │                  │                  │◀─────────────────────────────────────│
  │                  │                  │                  │                  │
  │                  │ 201 + Order      │                  │                  │
  │◀─────────────────│◀─────────────────│                  │                  │
```

---

### 5. 非功能设计

#### 5.1 安全设计

| 层面 | 措施 |
|------|------|
| 传输 | HTTPS / TLS 1.3 |
| 认证 | JWT (HS256, 30min 过期) |
| 授权 | RBAC 角色权限 |
| 密码 | Argon2id 哈希 |
| 注入 | 参数化查询 (SQLx) |
| 限流 | 100 req/min per IP |

#### 5.2 性能设计

| 场景 | 目标 | 措施 |
|------|------|------|
| 读接口 | P99 < 100ms | Redis 缓存热点数据 |
| 写接口 | P99 < 200ms | 异步处理非关键逻辑 |
| 列表查询 | P99 < 300ms | 分页 + 索引优化 |

#### 5.3 可观测性

```rust
// 日志规范
tracing::info!(
    user_id = %user_id,
    action = "create_order",
    order_id = %order.id,
    "订单创建成功"
);

// 关键指标
- http_requests_total{method, path, status}
- http_request_duration_seconds{method, path}
- db_pool_connections{state}
```

---

## 接口清单模板

| 模块 | 方法 | 路径 | 说明 | 认证 |
|------|------|------|------|------|
| 用户 | POST | /api/v1/auth/register | 注册 | 否 |
| 用户 | POST | /api/v1/auth/login | 登录 | 否 |
| 用户 | GET | /api/v1/users/me | 当前用户 | 是 |
| 用户 | PUT | /api/v1/users/me | 更新资料 | 是 |
| 订单 | POST | /api/v1/orders | 创建订单 | 是 |
| 订单 | GET | /api/v1/orders | 订单列表 | 是 |
| 订单 | GET | /api/v1/orders/{id} | 订单详情 | 是 |
| 订单 | PUT | /api/v1/orders/{id}/cancel | 取消订单 | 是 |

---

## 质量检查清单

| 类别 | 检查项 |
|------|--------|
| 子系统 | □ 职责单一明确 □ 边界规则清晰 □ 依赖关系无环 |
| 接口 | □ RESTful 规范 □ 版本化 □ 统一错误格式 □ 有 OpenAPI 定义 |
| 数据 | □ 实体关系图 □ 字段类型明确 □ 索引设计 □ 迁移脚本 |
| 流程 | □ 核心流程有时序图 □ 异常路径有说明 |
| 非功能 | □ 安全措施 □ 性能目标 □ 日志规范 |

---

## 总结

| HLD 关注 | 不关注 |
|----------|--------|
| 子系统如何划分 | 具体算法实现 |
| 接口契约是什么 | 内部代码结构 |
| 数据模型和关系 | 具体 SQL 优化 |
| 关键流程时序 | 每个分支细节 |

> **核心原则**：HLD 是开发的蓝图，定义**边界和契约**，让团队可以并行开发。