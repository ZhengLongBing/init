# 构建配置文档编写指南

---

## 核心理念

| 目标 | 说明 |
|------|------|
| 可复现 | 任何人、任何时间构建结果一致 |
| 快速 | 开发时快速编译，CI 时高效缓存 |
| 一键运行 | `just dev` 即可启动 |

---

## 基本概念

### Cargo 是什么

Cargo 是 Rust 的构建系统和包管理器，相当于 Node.js 的 npm + webpack，或 Java 的 Maven。

```
cargo build    → 编译项目
cargo run      → 编译并运行
cargo test     → 运行测试
cargo check    → 快速检查（不生成产物）
```

### 关键文件说明

| 文件 | 作用 | 类比 |
|------|------|------|
| `Cargo.toml` | 项目配置和依赖声明 | package.json |
| `Cargo.lock` | 锁定依赖的精确版本 | package-lock.json |
| `rust-toolchain.toml` | 锁定 Rust 编译器版本 | .nvmrc |
| `.cargo/config.toml` | Cargo 行为配置（链接器等） | - |

### Profile（构建配置）

Rust 有两个主要 profile：

| Profile | 命令 | 特点 |
|---------|------|------|
| `dev` | `cargo build` | 快速编译，无优化，含调试信息 |
| `release` | `cargo build --release` | 慢编译，全优化，用于生产 |

### Feature（条件编译）

Feature 允许按需启用功能，减少编译时间和二进制大小：

```toml
# 只启用需要的 feature
sqlx = { version = "0.8", features = ["postgres"] }  # ✅ 只要 postgres
sqlx = { version = "0.8", features = ["postgres", "mysql", "sqlite"] }  # ❌ 全都要
```

---

## 1. 项目结构

```
project/
├── .cargo/config.toml    # Cargo 本地配置
├── .gitlab-ci.yml        # GitLab CI
├── migrations/           # 数据库迁移
├── src/
├── tests/                # 集成测试
├── config/               # 多环境配置
│   ├── default.toml
│   └── production.toml
├── .env.example          # 环境变量模板
├── Cargo.toml
├── Cargo.lock            # ⚠️ 必须提交
├── justfile              # 常用命令
├── Dockerfile
└── rust-toolchain.toml   # Rust 版本锁定
```

---

## 2. Cargo.toml

```toml
[package]
name = "my-app"
version = "0.1.0"
edition = "2024"
rust-version = "1.85"

[dependencies]
axum = "0.7"
tokio = { version = "1", features = ["full"] }
sqlx = { version = "0.8", features = ["runtime-tokio", "postgres"] }
serde = { version = "1", features = ["derive"] }
tracing = "0.1"

[dev-dependencies]
tokio-test = "0.4"
mockall = "0.13"

[profile.dev.package."*"]
opt-level = 2              # 依赖优化编译，加速增量构建

[profile.release]
lto = "thin"
strip = true

[lints.rust]
unsafe_code = "forbid"

[lints.clippy]
all = "warn"
```

---

## 3. 环境配置

```bash
# .env.example
APP_ENV=development
DATABASE_URL=postgres://user:pass@localhost:5432/db
REDIS_URL=redis://localhost:6379
JWT_SECRET=your-secret-key-at-least-32-chars
RUST_LOG=info,sqlx=warn
```

```toml
# config/default.toml
[app]
port = 8080

[database]
max_connections = 10
```

```toml
# config/production.toml
[database]
max_connections = 50
```

---

## 4. 构建优化

### 为什么 Rust 编译慢？

Rust 编译慢主要在**链接阶段**——将编译好的代码块组装成可执行文件。更换链接器可大幅提速：

| 链接器 | 说明 |
|--------|------|
| ld（默认） | GNU 链接器，最慢 |
| lld | LLVM 链接器，快 2-4 倍 |
| mold | 最快，Linux 专用 |

```toml
# .cargo/config.toml
[target.x86_64-unknown-linux-gnu]
linker = "clang"
rustflags = ["-C", "link-arg=-fuse-ld=lld"]
```

### 优化效果

| 优化项 | 增量编译提升 |
|--------|--------------|
| lld 链接器 | 15s → 8s |
| 依赖优化编译 | 8s → 5s |
| sccache | 5s → 3s |

> **sccache** 是编译缓存工具，跨项目共享编译结果。安装：`cargo install sccache`

---

## 5. justfile

### 什么是 just？

[just](https://github.com/casey/just) 是现代化的命令运行器，比 Makefile 语法更简洁。安装：`cargo install just`

```just
set dotenv-load    # 自动加载 .env 文件

default:
    @just --list   # 默认显示所有命令

# 开发
dev:
    cargo run

dev-watch:
    cargo watch -x run

# 构建
build:
    cargo build --release

# 测试
test:
    cargo test

# 代码质量
lint:
    cargo fmt --all -- --check
    cargo clippy --all-targets -- -D warnings

fmt:
    cargo fmt --all

# 数据库
db-migrate:
    sqlx migrate run

db-reset:
    sqlx database drop -y && sqlx database create && sqlx migrate run

# Docker
docker-up:
    docker-compose up -d

docker-down:
    docker-compose down
```

---

## 6. GitLab CI

### CI/CD 流水线

代码推送后自动执行的检查和构建流程：

```
push → lint（代码规范）→ test（测试）→ build（构建）→ deploy（部署）
```

### 配置文件

```yaml
# .gitlab-ci.yml
stages:
  - check
  - test
  - build

variables:
  CARGO_HOME: ${CI_PROJECT_DIR}/.cargo  # 缓存依赖的位置

# 缓存配置：避免每次重新下载依赖
cache:
  key: ${CI_COMMIT_REF_SLUG}  # 按分支缓存
  paths:
    - .cargo/
    - target/

# 检查：代码格式 + 静态分析
lint:
  stage: check
  image: rust:1.85
  script:
    - rustup component add rustfmt clippy
    - cargo fmt --all -- --check
    - cargo clippy --all-targets -- -D warnings

# 测试：带数据库的集成测试
test:
  stage: test
  image: rust:1.85
  services:
    - postgres:16-alpine  # 启动 PostgreSQL 容器
  variables:
    DATABASE_URL: postgres://postgres:postgres@postgres:5432/test
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_DB: test
  script:
    - cargo test --all-features

# 构建：生成发布产物
build:
  stage: build
  image: rust:1.85
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/release/my-app
  only:
    - main
    - tags
```

---

## 7. Dockerfile

### 多阶段构建

Docker 多阶段构建将**编译环境**和**运行环境**分离，大幅减小镜像体积：

| 阶段 | 基础镜像 | 用途 |
|------|----------|------|
| builder | rust:1.85 (~1.5GB) | 编译代码 |
| runtime | debian:slim (~80MB) | 运行程序 |

### 依赖缓存技巧

先复制 `Cargo.toml` 编译依赖，再复制源码。这样源码变更时不会重新下载依赖。

```dockerfile
# 构建阶段
FROM rust:1.85-slim as builder
WORKDIR /app

# 1. 先编译依赖（利用 Docker 缓存）
COPY Cargo.toml Cargo.lock ./
RUN mkdir src && echo "fn main() {}" > src/main.rs
RUN cargo build --release && rm -rf src

# 2. 再编译源码
COPY .. .
RUN touch src/main.rs && cargo build --release

# 运行阶段
FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*
COPY --from=builder /app/target/release/my-app /app/
EXPOSE 8080
CMD ["/app/my-app"]
```

### 镜像大小对比

| 方式 | 镜像大小 |
|------|----------|
| 单阶段 (rust:1.85) | ~1.5GB |
| 多阶段 (debian:slim) | ~100MB |
| 多阶段 (alpine) | ~50MB |

---

## 8. 命令速查

| 场景 | 命令 |
|------|------|
| 开发运行 | `just dev` |
| 热重载 | `just dev-watch` |
| 测试 | `just test` |
| 格式化 | `just fmt` |
| Lint | `just lint` |
| 构建 | `just build` |
| 数据库迁移 | `just db-migrate` |
| 查看所有命令 | `just` |

---

## 质量检查清单

| 类别 | 检查项 |
|------|--------|
| 文件 | □ Cargo.lock 已提交 □ .env.example 存在 |
| Cargo | □ edition = "2024" □ profile 优化配置 |
| CI | □ lint □ test □ build |

> **核心原则**：构建配置追求**可复现**和**高效率**。